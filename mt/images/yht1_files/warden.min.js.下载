;!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.warden=t()}(this,function(){"use strict";var e=function(e){return"none"==e.style.display||(!!function(e){if(0==(0,window.getComputedStyle)(e).opacity)return!0;return!1}(e)||(!!function(e){var t=getComputedStyle(e),r=t.clip;if("absolute"===t.position||"fixed"===t.postion){var n=/rect\(([\s\S]+)\)/.exec(r);if(!n||!n[1])return!1;var i=n[1],o=i.split(" ");if(parseInt(o[0])>=parseInt(o[2])||parseInt(o[1])<=parseInt(o[3]))return!0}return!1}(e)||!(!function(e){var t=e.getBoundingClientRect(),r=t.left,n=t.top,i=t.right,o=t.bottom,c=void 0,a=void 0;if(a=window.innerWidth,c=window.innerHeight,i<=0)return!0;if(o<=0)return!0;if(r>=a)return!0;if(n>=c)return!0;return!1}(e)||function(e){return"html"==e.nodeName.toLocaleLowerCase()}(e)||function(e){return"body"==e.nodeName.toLocaleLowerCase()}(e))))};var t=function(e,t){return{left:Math.max(e.left,t.left),right:Math.min(e.right,t.right),top:Math.max(e.top,t.top),bottom:Math.min(e.bottom,t.bottom)}},r=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=function(){var e={left:0,top:0,right:window.innerWidth,height:window.innerHeight},t=Object.create(null);return t.basicRect=e,t.sharpRect=e,t}(),i=window.getComputedStyle,o=e.getBoundingClientRect(),c=i(e).position,a=i(e).overflow;return"fixed"==c?n:(r&&(n.basicRect=r.basicRect,n.sharpRect=r.sharpRect),"visible"==a?"absolute"==c&&(n.basicRect=n.sharpRect):"static"==c?n.basicRect=t(n.basicRect,o):"relative"==c?(n.sharpRect=t(n.basicRect,o),n.basicRect=t(n.sharpRect,n.basicRect)):(n.sharpRect=t(n.sharpRect,o),n.basicRect=n.sharpRect),n)};function n(i){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,c=arguments[2];return(i.ELEMENT_NODE==i.nodeType||i.TEXT_NODE==i.nodeType)&&(i.TEXT_NODE==i.nodeType?function(e,r){if(!e.data)return!1;if(null==e.data.match(/\S/))return!1;if("hidden"==(0,window.getComputedStyle)(e.parentElement).visibility)return!1;var n=e.parentElement.getBoundingClientRect(),i=t(r.basicRect,n),o=i.left,c=i.top,a=i.right,s=i.bottom;return!(o>=a||c>=s)}(i,c):!(!i.innerText&&1==o)&&(!e(i)&&("img"==i.nodeName.toLowerCase()&&2==o?function(e,r){if(!e.src)return!1;if("hidden"==(0,window.getComputedStyle)(e).visibility)return!1;var n=e.getBoundingClientRect(),i=t(r.basicRect,n),o=i.left,c=i.top,a=i.right,s=i.bottom;return!(o>=a||c>=s)}(i,c):function(e,t,i){for(var o=r(e,i),c=e.childNodes,a=c.length,s=0;s<a;s++){var u=n(c[s],t,o);if(u)return!0}return!1}(i,o,c))))}var i=function(){var e=function(){Object.create(null);return{left:0,top:0,right:window.innerWidth,bottom:window.innerHeight}}(),r=document.getElementsByTagName("html")[0],n=document.getElementsByTagName("body")[0],i=window.getComputedStyle,o=Object.create(null);if(o.sharpRect=e,o.basicRect=o.sharpRect,"visible"!=i(r).overflow&&"visible"!=i(n).overflow){var c=n.getBoundingClientRect();o.basicRect=t(c,o.sharpRect)}return o};function o(n){if("html"==n.nodeName.toLocaleLowerCase()||"body"==n.nodeName.toLocaleLowerCase())return console.warn("请不要将data-rye设置在body或者html上"),!0;var o=function(e){var t=[],r=e;for(;r;)t.unshift(r),r=r.parentElement;return t}(n);o.pop();var c=o.shift(),a=o.shift();if(e(c)||e(a))return!1;for(var s=i(),u=0;u<o.length;u++){if(e(o[u]))return!1;s=r(o[u],s)}return!e(n)&&function(e,r){if("hidden"==(0,window.getComputedStyle)(e).visibility)return!1;var n=e.getBoundingClientRect(),i=t(r.basicRect,n),o=i.left,c=i.top,a=i.right,s=i.bottom;return!(o>=a||c>=s)}(n,s)}function c(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=function(e){return document.querySelectorAll('[key-dom="'+e+'"]')}(e);if(!r||!r.length)return!1;var n=0;if(t==1/0)for(var i=0;i<r.length;i++){if(!o(r[i]))return!1}else for(var c=0;c<r.length;c++){if(o(r[c])&&++n>=t)return!0}return!1}function a(){return!!window.Owl&&(Owl.addError instanceof Function||(console.warn("没有引入cat"),!1))}function s(e){var t=new XMLHttpRequest,r=!!a()&&Owl.cfgManager._config,n=r&&r.project||"未知",i="//catfront.dianping.com/api/log?v=1",o=(Math.random(),e.content),c=void 0===o?"":o;e=[{sec_category:e.sec_category,msg:e.msg,project:"warden",pageUrl:window.location.origin+window.location.pathname,category:"jsError",level:"info",region:n,container:n,sub_project:n}],c&&(e[0].content=c);var s="c="+encodeURIComponent(JSON.stringify(e));t.open("POST",i,!1),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.send(s)}var u=function(){return window.globalParam&&window.globalParam.t0?globalParam.t0:this.__t0?this.__t0:performance&&performance.timing?performance.timing.navigationStart:void 0},l=function(){var e=this.CONFIG.renderType,t=void 0===e?"frontend":e,r=0;if(this.tempFCPStampByReport)return this.tempFCPStampByReport-u.call(this);switch(t){case"server":r=f.call(this);break;case"frontend":default:r=d.call(this)}return r},f=function(){return this.tempFCPStampOfServer-u.call(this)},d=function(){var e=this.tempFCPStampOfFrontEnd;return document.querySelectorAll("[key-script]").length<1?e-u.call(this):m.call(this)},m=function(){var e=[].slice.call(document.querySelectorAll("[key-script]")),t=[].slice.call(document.querySelectorAll("[key-css]")),r=performance.getEntriesByType("resource").filter(function(e){return"img"!==e.initiatorType&&"xmlhttprequest"!==e.initiatorType}).sort(function(e,t){return t.responseEnd-e.responseEnd}),n=r.filter(function(r){var n=e.find(function(e){return e.src===r.name});return n=n||t.find(function(e){return e.href===r.name})});return n.length<1?r.length>0?r[0].responseEnd:0:(n=n.sort(function(e,t){return t.responseEnd-e.responseEnd}))[0].responseEnd};function p(e){var t=e.target||e.srcElement;if(t){var r=t.nodeName;if(r){if("script"==(r=r.toLocaleLowerCase())){if(null===t.getAttribute("key-script"))return;!function(e){if(a()){var t=(e.target||e.srcElement).src;Owl.addError({name:"keyScriptError",msg:t})}}(e)}if("link"==r){if(null===t.getAttribute("key-css"))return;!function(e){if(a()){var t=(e.target||e.srcElement).href;Owl.addError({name:"keyCssError",msg:t})}}(e)}}}}var h=function(){var e=l.call(this);s({sec_category:"FCP",msg:"FCP统计时间",content:e})},g=function(){var e=function(){var e=l.call(this),t=performance.getEntriesByType("resource").filter(function(t){return"img"!==t.initiatorType&&"xmlhttprequest"!==t.initiatorType&&t.responseEnd<=e});return{resourceNum:t.length,resourceSize:t.reduce(function(e,t){return{transferSize:e.transferSize+(t.transferSize||0)}}).transferSize}}.call(this),t=e.resourceNum,r=e.resourceSize;s({sec_category:"FCPResource",msg:"FCP统计资源数量与大小",content:{resourceNum:t,resourceSize:r}})},y=function(){var e,t,r=(e=performance.getEntriesByType("resource"),t=e.filter(function(e){return 0===e.redirectStart&&0===e.redirectEnd&&0===e.domainLookupStart&&0===e.domainLookupEnd&&0===e.connectStart&&0===e.connectEnd&&0===e.secureConnectionStart&&0===e.requestStart&&0===e.responseStart}),{resourceNum:e.length,resourceNumOfNoTAOHeader:t.length});s({sec_category:"TAOHeaderInfo",msg:"没有Timing-Allow-Origin Header统计",content:{resourceNum:r.resourceNum,resourceNumOfNoTAOHeader:r.resourceNumOfNoTAOHeader}})};var w=window._MeiTuanWardenObject||"warden",v=window[w]||{};function _(){try{(function(){s({sec_category:"wardenCovered",msg:"warden覆盖"});var e=this.__checkList;e&&(e.whiteScreen&&s({sec_category:"whiteScreenCovered",msg:"白屏监控覆盖"}),e.keyDom&&s({sec_category:"keyDomCovered",msg:"关键节点监控覆盖"}),e.keyCss&&s({sec_category:"keyCssCovered",msg:"关键css监控覆盖"}),e.keyScript&&s({sec_category:"keyScriptCovered",msg:"关键script监控覆盖"}))}).call(v),h.call(v),g.call(v),y.call(v)}catch(e){console.log(e)}}return v.__checkList={},v.isShow=function(e,t,r){this.__checkList.keyDom=!0;var n=c(e,t);return n||function(e,t,r){a()&&Owl.addError({name:"keyDomError",msg:e},{tags:{info:r}})}(e,0,r),n},v.isWhite=function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;this.__checkList.whiteScreen=!0;var o=document.getElementsByTagName("html")[0],c=document.getElementsByTagName("body")[0];if(e(o)||e(c))return!1;var s=n(c,r,i());return s||function(e){a()&&Owl.addError({name:"whiteScreenError",msg:"页面白屏"},{tags:{info:e}})}(t),!s},v.reportError=p,v.pageError=function(e,t){a()&&Owl.addError({name:"pageError",msg:e},{tags:{info:t,refer:document.referrer}})},v.reportT5=function(e){var t,r,n,i=u.call(this),o=this.__t0s=this.__t0s||{};o[i]&&console.warn("多次上报t5,请查看是否在同一页面多次调用warden.finish方法"),o[i]=!0,t=13,r=e-i,a()&&(Owl.addPoint(t,r,n),Owl.sendPoints())},function(){if(window.history){var e=history.pushState.bind(history),t=history.replaceState.bind(history),r=this;history.pushState=function(){_.call(r),r.__t0=(new Date).getTime(),e.apply(void 0,arguments)},history.replaceState=function(){_.call(r),r.__t0=(new Date).getTime(),t.apply(void 0,arguments)},window.addEventListener("popstate",function(){_.call(r),r.__t0=(new Date).getTime()})}}.call(v),function(){var e=this;window.addEventListener("hashchange",function(t){_.call(e),e.__t0=(new Date).getTime()})}.call(v),v.__ready=!0,v.__inits=v.__inits||[],v.__errs=v.__errs||[],v.__inits.forEach(function(e){e instanceof Function&&e(v);var t=document.querySelectorAll("[key-css]").length,r=document.querySelectorAll("[key-script]").length;t>0&&(v.__checkList.keyCss=!0),r>0&&(v.__checkList.keyScript=!0)}),v.__errs.forEach(function(e){p(e)}),window.onbeforeunload=_,v});

